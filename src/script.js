const CONFIG={json:"https://raw.githubusercontent.com/Pro-Bandey/minimalistic-wallpapers/output/images-meta.json",imageBase:"https://raw.githubusercontent.com/Pro-Bandey/minimalistic-wallpapers/main/",limit:36,NEW_DAYS:14};let allData=[],filtered=[],curIdx=0,page=0;const state={theme:localStorage.getItem("theme")||"dark",layout:localStorage.getItem("layout")||(window.innerWidth<768?"l-grid-medium":"l-grid-small"),sort:localStorage.getItem("sort")||"name",order:localStorage.getItem("order")||"asc"};async function start(){"light"===state.theme&&document.body.classList.add("light"),document.getElementById("sort-by").value=state.sort;const e=document.getElementById("layout-sel");if((window.innerWidth<768?[{id:"l-grid-large",n:"Grid"},{id:"l-single",n:"Single"},{id:"l-details",n:"Details"}]:[{id:"l-grid-small",n:"Grid"},{id:"l-grid-medium",n:"Grid Med"},{id:"l-grid-large",n:"Grid Large"},{id:"l-single",n:"Single"},{id:"l-details",n:"Details"},{id:"l-compact",n:"Compact"}]).forEach((t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.n,t.id===state.layout&&(n.selected=!0),e.appendChild(n)})),window.innerWidth>768){const e=document.getElementById("cur-ring");document.addEventListener("mousemove",(t=>{e.style.left=t.clientX+"px",e.style.top=t.clientY+"px",document.body.classList.toggle("is-ptr",!!t.target.closest("a, button, input, select, .card, .tab, .dots-btn, .field"));const n=e.querySelector("span");document.body.classList.contains("is-ptr")?n.textContent="pointer":n.textContent="pan_tool_alt"}))}await fetchFiles();const t=new URLSearchParams(window.location.search).get("q");t&&(document.getElementById("search-in").value=t),apply()}async function fetchFiles(){try{const e=await fetch(CONFIG.json,{cache:"no-store"});if(!e.ok)throw new Error("JSON fetch failed");const t=await e.json(),n=Date.now(),a=864e5*CONFIG.NEW_DAYS;allData=t.images.map((e=>{const t=new Date(e.dates?.added||e.dates?.updated||Date.now()).getTime(),o="number"==typeof e.kb?e.kb:e.sizeBytes?e.sizeBytes/1024:0;return{raw:e,id:e.id||"",name:e.name||e.src.split("/").pop(),url:CONFIG.imageBase+e.src,folder:e.folder||"root",path:e.src,ext:e.ext||e.src.split(".").pop()||"",type:(e.ext||e.src.split(".").pop()||"").toUpperCase(),kb:o,rawSize:Math.round(1024*o),sizeStr:`${o.toFixed(2)} KB`,res:"...",resArea:0,dates:e.dates||{},hash:e.hash||"",tags:e.tags||[],date:t,isNew:n-t<=a}}))}catch(e){alert("Failed to load images metadata.")}}function apply(){const e=document.getElementById("search-in").value.toLowerCase();filtered=allData.filter((t=>t.name.toLowerCase().includes(e)));const t=document.getElementById("sort-by").value;filtered.sort(((e,n)=>{if("date"===t)return"asc"===state.order?e.date-n.date:n.date-e.date;const a=e[t],o=n[t];return"string"==typeof a?"asc"===state.order?a.localeCompare(o):o.localeCompare(a):"asc"===state.order?a-o:o-a})),page=0,render()}function render(){const e=document.getElementById("gallery"),t=document.getElementById("layout-sel").value;e.className=t,e.innerHTML="";const n=page*CONFIG.limit;filtered.slice(n,n+CONFIG.limit).forEach(((t,a)=>{const o=n+a,i=document.createElement("div");let l;i.className="card",i.onclick=()=>openLB(o),i.oncontextmenu=e=>openMenu(e,o,"card"),i.ontouchstart=e=>l=setTimeout((()=>openMenu(e,o,"card")),700),i.ontouchend=()=>clearTimeout(l);i.innerHTML=`\n          <div class="img-hld">\n            ${t.isNew?'<div class="badge-rgb">NEW</div>':""}\n            <img src="${t.url}" alt="${t.id}" loading="lazy" decoding="async" onload="setRes(this, ${o})" width="100%" height="auto">\n          </div>\n          <button class="dots-btn" onclick="openMenu(event, ${o}, 'card')">\n            <span class="material-icons">more_vert</span>\n          </button>\n          <div class="card-meta">\n            <div class="name">${t.name}</div>\n            <div class="res" id="r-${o}">${t.res}</div>\n            <div class="meta-row-icons">\n              <span class="meta-file" title="File Size"><span class="material-icons" title="Size">save</span> ${t.sizeStr}</span>\n              <span class="meta-file" title="Extension"><span class="material-icons" style="vertical-align:middle;" title="File Type">image</span> ${t.type}</span>\n              <span class="meta-file" title="Folder"><span class="material-icons" title="Folder">folder</span> ${t.folder}</span>\n            </div>\n          </div>\n        `,e.appendChild(i)})),renderTabs()}function setRes(e,t){const n=e.naturalWidth,a=e.naturalHeight,o=`${n}x${a}`,i=filtered[t];i&&(i.res=o,i.resArea=n*a);const l=i?.id;if(l){const e=allData.find((e=>e.id===l));e&&(e.res=o,e.resArea=n*a)}e.classList.add("loaded");const s=document.getElementById(`r-${t}`);s&&(s.innerText=o)}function renderTabs(){const e=document.getElementById("tabs");e.innerHTML="";const t=Math.ceil(filtered.length/CONFIG.limit);if(!(t<=1))for(let n=0;n<t;n++){const t=document.createElement("button");t.className="tab "+(n===page?"active":""),t.innerText=n+1,t.onclick=()=>{page=n,render(),window.scrollTo(0,0)},e.appendChild(t)}}const Actions={tab:e=>window.open(filtered[e].url,"_blank"),dl:async e=>{const t=filtered[e],n=await fetch(t.url).then((e=>e.blob())),a=document.createElement("a");a.href=URL.createObjectURL(n),a.download=t.name,a.click()},copyI:async e=>{const t=await fetch(filtered[e].url),n=await t.blob();try{await navigator.clipboard.write([new ClipboardItem({[n.type]:n})]),alert("Image copied to clipboard!")}catch(e){alert("Copy failed: Browser restriction.")}},shareI:async e=>{const t=await fetch(filtered[e].url).then((e=>e.blob())),n=new File([t],filtered[e].name,{type:t.type});navigator.canShare&&navigator.canShare({files:[n]})&&navigator.share({files:[n]})},copyU:e=>{navigator.clipboard.writeText(filtered[e].url),alert("Link Copied!")},shareU:e=>navigator.share?.({title:filtered[e].name,url:filtered[e].url})?.catch((()=>{})),props:e=>{const t=filtered[e]||{},n=t.raw||{},a=t.dates?.added?new Date(t.dates.added):t.date?new Date(t.date):null,o=t.dates?.updated?new Date(t.dates.updated):null,i=a?a.toLocaleDateString(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}):"—",l=o?o.toLocaleDateString(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}):t.dates?.updated?new Date(t.dates.updated).toLocaleDateString(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}):"—",s=`\n          <div class="prop-grid">\n            ${`<div class="prop-preview"><img src="${t.url}" alt="${t.id}" onload="this.classList.add('loaded')"></div>`}\n            <div class="prop-list">\n              ${[{l:"Filename",v:t.name||"—"},{l:"ID",v:t.id||"—"},{l:"Resolution",v:t.res||"—"},{l:"File Size",v:t.sizeStr+` (${(t.rawSize||0).toLocaleString()} bytes)`},{l:"Format",v:t.type||(t.ext||"—").toUpperCase()},{l:"Folder",v:`<span class="material-icons" title="Folder" style="vertical-align:middle; font-size:15px;">folder</span> ${t.folder||"—"}`},{l:"Repo Path",v:t.path||"—"},{l:"Added",v:i},{l:"Updated",v:l},{l:"Hash",v:t.hash||"—"},{l:"Tags",v:Array.isArray(t.tags)?t.tags.join(", "):t.tags||"—"}].map((e=>`\n          <div class="prop-item">\n            <div style="display:flex; gap:8px; align-items:center;">\n              <span class="prop-label">${e.l}</span>\n              <span class="prop-val" id="pv-${e.l.replace(/\s+/g,"-")}">${e.v}</span>\n            </div>\n            <div style="display:flex; gap:6px; align-items:center;">\n              <button class="copy-btn" onclick="copyProp('${escapeForCopy(e.v)}')">Copy</button>\n            </div>\n          </div>`)).join("")}\n              ${`<details open><summary style="cursor:pointer">Show raw JSON</summary><pre>${escapeHtml(JSON.stringify(n,null,2))}</pre></details>`}\n            </div>\n          </div>\n        `;document.getElementById("prop-body").innerHTML=s,document.getElementById("prop-popup").style.display="block",document.getElementById("prop-popup").setAttribute("aria-hidden","false"),document.body.style.overflow="hidden"}};function escapeHtml(e){return String(e).replace(/[&<>]/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[e])))}function escapeForCopy(e){return null==e?"":String(e).replace(/'/g,"\\'").replace(/"/g,'\\"')}function copyProp(e){try{navigator.clipboard.writeText(e),alert("Copied: "+(e.length>120?e.slice(0,120)+"...":e))}catch(e){alert("Copy failed: "+(e.message||e))}}function hideMenus(){document.getElementById("m3-menu").style.display="none"}function openMenu(e,t,n){e&&(e.preventDefault(),e.stopPropagation()),curIdx=t;const a=document.getElementById("m3-menu"),o="lb"===n?[{k:"tab",n:"Open Tab",i:"open_in_new"},{k:"dl",n:"Download",i:"file_download"},{k:"copyI",n:"Copy Image",i:"perm_media"},{k:"shareI",n:"Share File",i:"image"},{k:"copyU",n:"Copy Link",i:"link"},{k:"shareU",n:"Share Link",i:"share"},{k:"props",n:"Details",i:"info"}]:[{k:"lb",n:"Open",i:"visibility"},{k:"shareU",n:"Quick Share",i:"share"},{k:"props",n:"Properties",i:"info"}];if(a.innerHTML=o.map((e=>`\n        <button onclick="exec('${e.k}', ${t})">\n          <span class="material-icons" style="font-size:20px">${e.i}</span>\n          <span>${e.n}</span>\n        </button>\n      `)).join(""),a.style.display="block",e&&e.clientX){const t=Math.min(e.clientX,window.innerWidth-260),n=Math.min(e.clientY,window.innerHeight-50*o.length);a.style.left=t+"px",a.style.top=n+"px",a.style.transform="none"}else a.style.left="50%",a.style.top="50%",a.style.transform="translate(-50%,-50%)"}function exec(e,t){hideMenus(),"lb"===e?openLB(t):Actions[e]&&Actions[e](t)}function openLB(e){curIdx=e;const t=filtered[e];if(document.getElementById("lb-img").src=t.url,document.getElementById("lightbox").style.display="flex",document.body.style.overflow="hidden",window.innerWidth>768){const t=[{k:"tab",n:"Tab",i:"open_in_new"},{k:"dl",n:"Download",i:"file_download"},{k:"copyI",n:"Copy",i:"perm_media"},{k:"shareI",n:"Share",i:"image"},{k:"copyU",n:"Link",i:"link"},{k:"shareU",n:"Share Link",i:"share"},{k:"props",n:"Properties",i:"info"}];document.getElementById("lb-actions-dk").innerHTML=t.map((t=>`\n          <button class="field" onclick="Actions.${t.k}(${e})" style="display:inline-flex; align-items:center; gap:8px;">\n            <span class="material-icons" style="font-size:18px">${t.i}</span> ${t.n}\n          </button>\n        `)).join("")}}function closeLB(){document.getElementById("lightbox").style.display="none",document.body.style.overflow="auto"}function closeProps(){document.getElementById("prop-popup").style.display="none",document.getElementById("prop-popup").setAttribute("aria-hidden","true"),document.body.style.overflow="auto"}function nav(e){curIdx=(curIdx+e+filtered.length)%filtered.length,openLB(curIdx)}document.getElementById("theme-tog").onclick=()=>{document.body.classList.toggle("light"),localStorage.setItem("theme",document.body.classList.contains("light")?"light":"dark")},document.getElementById("layout-sel").onchange=e=>{localStorage.setItem("layout",e.target.value),render()},document.getElementById("sort-by").onchange=e=>{state.sort=e.target.value,localStorage.setItem("sort",e.target.value),apply()};const btn=document.getElementById("sort-order");btn.onclick=function(){state.order="asc"===state.order?"desc":"asc",localStorage.setItem("order",state.order),this.style.transform="scaleY(-1)"===this.style.transform?"scaleY(1)":"scaleY(-1)",apply()};const savedOrder=localStorage.getItem("order");if("desc"===savedOrder?(state.order="desc",btn.style.transform="scaleY(-1)"):(state.order="asc",btn.style.transform="scaleY(1)"),document.getElementById("search-in").oninput=e=>{const t=new URL(window.location);e.target.value?t.searchParams.set("q",e.target.value):t.searchParams.delete("q"),window.history.replaceState({},"",t),apply()},window.onscroll=hideMenus,window.addEventListener("click",(e=>{e.target.closest(".m3-menu")||e.target.closest(".dots-btn")||hideMenus()})),"ontouchstart"in window){let e=0;document.getElementById("lightbox").ontouchstart=t=>e=t.touches[0].clientX,document.getElementById("lightbox").ontouchend=t=>{const n=t.changedTouches[0].clientX;e-n>70&&nav(1),n-e>70&&nav(-1)}}start();